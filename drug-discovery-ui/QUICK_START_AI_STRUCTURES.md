# AI Structure Generation - Quick Reference

## What Changed?

The Property Predictor now uses **AI to automatically generate molecular structures** when they're not available in the database.

```
User enters "Dopamine" → Not in database → AI generates SMILES → Prediction runs
```

---

## Files Changed

### Frontend
| File | Changes |
|------|---------|
| `src/services/structureGeneration.ts` | **NEW** - AI structure generation service |
| `src/features/property-predictor/PropertyPredictorPage.tsx` | Enhanced with AI fallback logic |

### Backend
| File | Changes |
|------|---------|
| `backend/app/api/routes/structure.py` | NEW endpoint: `POST /api/v1/structure/generate-ai` |

---

## Key Functions

### Frontend Service

```typescript
// Import
import { enrichWithAIStructure } from '@/services/structureGeneration'

// Usage
const result = await enrichWithAIStructure('Dopamine')
// Returns: { smiles?, source: 'direct'|'ai'|'database', metadata? }
```

### Backend Endpoint

```bash
curl -X POST http://localhost:8000/api/v1/structure/generate-ai \
  -H "Content-Type: application/json" \
  -d '{"moleculeName": "dopamine"}'
```

---

## UI Changes

### New Visual Element: AI-Generated Structure Panel
Shows when a structure was generated by AI:
- Molecular formula
- SMILES string
- IUPAC name
- Confidence score
- Export button

### Loading States
- `"Generating Structure…"` - AI is working
- `"✨ AI-Generated Structure"` - Success
- Shows confidence and formula

---

## How It Works (Step by Step)

1. **User Input**: "Dopamine" (molecule name)
2. **Check for SMILES**: Not provided? Continue...
3. **Try Database**: PubChem lookup → Not found
4. **Trigger AI**: Call `/api/v1/structure/generate-ai`
5. **Generate**: OpenAI returns SMILES + metadata
6. **Cache**: Store for 1 hour
7. **Predict**: Use generated SMILES for properties
8. **Display**: Show results + AI metadata panel

---

## Error Handling

The system gracefully handles failures:

```
AI Unavailable → Continue with molecule name
No SMILES Generated → Use heuristic properties
Network Error → Show friendly message
```

---

## Testing Quick Checklist

- [ ] Enter known molecule → Uses database (fast)
- [ ] Enter novel molecule → Triggers AI (2-5 sec)
- [ ] Provide SMILES directly → Skips both lookups
- [ ] Check AI panel appears → Green section visible
- [ ] Export structure → Downloads JSON
- [ ] View properties → Works with AI SMILES
- [ ] Check history → Entry shows correct source

---

## Configuration

**No new environment variables needed!**

Uses existing OpenAI config:
```
AZURE_OPENAI_ENDPOINT
AZURE_OPENAI_DEPLOYMENT
OPENAI_API_KEY
```

---

## Cache Details

| Property | Value |
|----------|-------|
| TTL | 1 hour |
| Key Format | `ai_structure:molecule_name` |
| Storage | In-memory (expandable to Redis) |

---

## Performance

| Operation | Duration |
|-----------|----------|
| Database lookup | 100-500ms |
| AI generation | 2-5 seconds |
| Property prediction | 1-2 seconds |
| **Total (with AI)** | **3-6 seconds** |

---

## Common Issues

| Problem | Solution |
|---------|----------|
| Slow AI generation | Check Azure OpenAI status |
| Invalid SMILES | Will add RDKit validation |
| Cache not working | Verify cache is configured |
| AI not called | Check console for errors |

---

## Code Examples

### Property Predictor Component

```tsx
// Now includes AI structure enrichment
const enrichedData = await enrichWithAIStructure(moleculeName)
if (enrichedData.smiles) {
  smiles = enrichedData.smiles
  setStructureSource(enrichedData.source)
}
```

### Service Function

```typescript
export async function enrichWithAIStructure(
  moleculeName: string,
  existingSMILES?: string
) {
  // If SMILES provided, use it
  if (existingSMILES) {
    return { smiles: existingSMILES, source: 'direct' }
  }

  // Otherwise, try AI generation
  const result = await generateStructureWithAI({ moleculeName })
  if (result.success && result.smiles) {
    return {
      smiles: result.smiles,
      source: 'ai',
      metadata: { /* confidence, formula, etc. */ }
    }
  }
}
```

---

## Next Steps

### Immediate (Ready to Use)
- ✅ AI structure generation
- ✅ UI display of AI metadata
- ✅ Caching
- ✅ Error handling

### Future Enhancements
- [ ] RDKit validation of generated SMILES
- [ ] Batch structure generation
- [ ] User corrections/feedback
- [ ] Structure similarity search
- [ ] Multiple AI model fallbacks

---

## Documentation

- **Full Guide**: `AI_STRUCTURE_GENERATION.md`
- **API Reference**: See structure.py file
- **Service Code**: `src/services/structureGeneration.ts`

---

## Questions?

Check:
1. Browser console (frontend errors)
2. Terminal uvicorn logs (backend errors)
3. Network tab (API calls)
4. Full documentation in `AI_STRUCTURE_GENERATION.md`
